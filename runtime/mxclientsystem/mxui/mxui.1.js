/* @preserve
Copyright (c) 2005-2023, Mendix BV. All rights reserved.
See mxclientsystem/licenses.txt for third party licenses that apply.
*/
(self.mxJsonp=self.mxJsonp||[]).push([[1],{4258:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.FileBackend=void 0;var i=n(2381),s=n(7779),a=n(2813),r=n(4036);function o(e){return e.split(/\/([^/]+)$/)}function c(e){return new Promise(((t,n)=>{const i=new FileReader;i.onload=e=>t(e.target.result),i.onerror=e=>n(e.target.error),i.readAsArrayBuffer(e)}))}t.FileBackend=class{constructor(e,t){this._config=e,this._storageDirPromise=null,this._rootDir=t,this._downloadQueue=new s.AsyncTaskThrottler(((e,t)=>new Promise(((n,i)=>{this._config.downloadFileFn?this._config.downloadFileFn(e,t,n,i):(0,r.get)(e,"blob").then((e=>this.storeFile(e,t))).then(n).catch(i)}))))}async listDir(e){try{const t=(await this._openDir(e)).createReader();return await new Promise(((e,n)=>{const i=[],s=()=>{t.readEntries((t=>{0!==t.length?(i.push(...t.map((e=>e.name))),s()):e(i)}),n)};s()}))}catch(e){return[]}}async removeDir(e){try{const t=await this._openDir(e);await(0,a.callbackToPromise)(t.removeRecursively.bind(t))}catch(e){}}readFile(e){return this._openFile(e).then((e=>function(e){return(0,a.callbackToPromise)(e.file.bind(e)).then(c).then((e=>new Blob([e])))}(e)))}storeFile(e,t){return this._openFile(t,!0).then((t=>{return n=t,i=e,(0,a.callbackToPromise)(n.createWriter.bind(n)).then((e=>function(e,t){return new Promise(((n,i)=>{t.onwrite=n,t.onerror=i,t.write(e)}))}(i,e)));var n,i}))}async moveFile(e,t){const n=await this._openFile(e),[i,s]=o(t),a=await this._openDir(i);await function(e,t,n){return new Promise(((i,s)=>{e.moveTo(t,n,i,s)}))}(n,a,s)}async moveDir(e,t){const n=await this.listDir(e);for(const i of n){const n=await i,s=`${e}/${n}`,a=`${t}/${n}`;(await this._openFile(s)).isDirectory?await this.moveDir(s,a):await this.moveFile(s,a)}}async removeFile(e){const t=await this._openFile(e);await(0,a.callbackToPromise)(t.remove.bind(t))}downloadFile(e,t){return this._downloadQueue.addToQueue(e,t)}async _openFile(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const[n,i]=o(e),s=await this._openDir(n,t);return(0,a.callbackToPromise)(s.getFile.bind(s),i,{create:t})}async _openDir(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const n=e.split("/").filter((e=>""!==e));let i=await this._getStorageDir();for(let e=0;e<n.length;++e)i=await(0,a.callbackToPromise)(i.getDirectory.bind(i),n[e],{create:t});return i}toAbsolutePath(e){var t;return(0,i.toAbsolutePath)(null!==(t=this._rootDir)&&void 0!==t?t:i.DEFAULT_FILES_DIRECTORY,e)}_getStorageDir(){return this._config.getStorageDirFn?(0,a.callbackToPromise)(this._config.getStorageDirFn):(null===this._storageDirPromise&&(this._storageDirPromise=(0,a.callbackToPromise)(window.webkitRequestFileSystem,window.TEMPORARY,1048576).then((e=>e.root))),this._storageDirPromise)}}},3807:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ReaderT=function(e){function t(e){this.run=e}return t.prototype.chain=function(e){return new t(function(t){return this.run(t).chain((function(n){return e(n).run(t)}))}.bind(this))},t.prototype.ap=function(e){return new t(function(t){return this.run(t).ap(e.run(t))}.bind(this))},t.prototype.map=function(e){return this.chain((function(n){return t.of(e(n))}))},t.of=function(n){return new t((function(t){return e.of(n)}))},t.ask=function(){return new t(e.of)},t}},1650:(e,t)=>{function n(e){this.fork=e}Object.defineProperty(t,"__esModule",{value:!0}),t.Task=n,n.of=function(e){return new n((function(t,n){n(e)}))},n.prototype.chain=function(e){var t=this;return new n((function(n,i){t.fork(n,(function(t){e(t).fork(n,i)}))}))},n.prototype.orElse=function(e){var t=this;return new n((function(n,i){t.fork((function(t){e(t).fork(n,i)}),i)}))},n.prototype.ap=function(e){var t,i,s,a=this,r=2;return new n((function(n,o){function c(){0==--r&&o(t(i))}function u(e){void 0===s&&n(s=e)}a.fork(u,(function(e){t=e,c()})),e.fork(u,(function(e){i=e,c()}))}))},n.prototype.map=function(e){return this.chain((function(t){return n.of(e(t))}))},n.rejected=n.prototype.rejected=function(e){return new n((function(t,n){t(e)}))},n.parallel=function(e){return new n((function(t,n){var i,s=e.length,a=new Array(e.length);0!==e.length?e.forEach((function(e,r){e.fork((function(e){void 0===i&&(i=e,t(e))}),function(e){return function(t){a[e]=t,void 0===i&&0==--s&&n(a)}}(r))})):n(a)}))},n.sequence=function(e){return e.reduce((function(e,t){return e.chain((function(e){return t}))}),n.of(null))}},790:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.TaskReader=void 0;var i=n(3807),s=n(1650);const a=new i.ReaderT(s.Task);t.TaskReader=a,a.rejected=function(e){return new a((function(t){return s.Task.rejected(e)}))},a.parallel=function(e){return new a((t=>new s.Task(((n,i)=>{if(0===e.length)return void i([]);const s=new Array(e.length);let a=e.length,r=!1;e.forEach(((e,o)=>{e.run(t).fork((e=>{r||(r=!0,n(e))}),(e=>{s[o]=e,r||0!=--a||i(s)}))}))}))))},a.sequence=function(e){return e.reduce(((e,t)=>e.chain((e=>t.map((t=>e.concat([t])))))),a.of([]))}},2314:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.OfflineDataBackend=void 0,t.jsonToObject=j,t.objectToJson=O;var i=n(2381),s=n(6297),a=n(3698),r=n(1070),o=n(4296),c=n(178),u=n(3482),l=n(5247),d=n(2664),h=n(4037),f=n(6355),m=n(7223),p=n(3282);class g extends l._DataBackend{constructor(e,t,n,i){super(),this._store=t,this._getDocumentUrl=i||y,this._objectCache=e,this._fileBackend=n}async getByGuid(e,t){const n=(await Promise.all(e.map((e=>this._getByGuid(e))))).filter((e=>null!=e)).map((e=>O(e)));return this._objectCache.setMxObjects(n),{mxobjs:n.map((e=>{let{guid:t}=e;return this._objectCache.getObject(t)})),count:n.length}}async getByPath(e,t,n,i){const s=(0,a.getAssociationStep)(t);if("reverse"===i){var o;const{cachedObjects:c}=(0,a.getCachedObjectsByPath)(e,i,t,this._objectCache),l=(null!==(o=(0,h.getEntityMeta)(n))&&void 0!==o&&o.isPersistable?await this._store.getByAttribute(n,s,(0,r.getRuntimeGuid)(e)):[]).map(O).map((e=>r.syncedObjsRuntimeToOfflineMap.mapMxObjectJSON(e))).filter((t=>u.MxObject.fromJson(t).getReferences(s).includes(e))).filter((e=>!c.some((t=>t.getGuid()===e.guid))));this._objectCache.setMxObjects(l);const d=c.concat(l.map((e=>this._objectCache.getObject(e.guid))));return{mxobjs:d,count:d.length}}{let t=this._objectCache.getObject(e);if(!t){const{mxobjs:[n]}=await this.getByGuid([e]);n&&(t=n)}if(!t)return{mxobjs:[],count:0};const{cachedObjects:n,uncachedGuids:i}=(0,a.getRefsObjects)(t,this._objectCache,s),{mxobjs:r}=await this.getByGuid(i),o=r.concat(n);return this._objectCache.setMxObjects(r.map((e=>e.jsonData))),{mxobjs:o,count:o.length}}}async commit(e,t){const n=(0,o.objectFromArray)(e.map((e=>[e,(0,d.clone)(this._objectCache.getChanges(e))]))),[i,a]=(0,p.partition)((e=>this._objectCache.has(e)),e),c=i.map((e=>this._objectCache.getObject(e))),[u,l]=(0,p.partition)((e=>e.isPersistable()),c),h=u.map(b),f=(await Promise.all(a.map((e=>this._getByGuid(e))))).concat(h).map(y);if(f.length>0){const e=r.syncedObjsRuntimeToOfflineMap.reverse();await(0,m.offlineData)().insertOrReplace(f.map((t=>e.mapMxObjectJSON(O(t))))),(0,s.markAsDirty)(f.map((e=>e.guid))),this._objectCache.setMxObjects(f.map((e=>O(e))))}const g=l.map(b).map(y);return this._objectCache.setMxObjects(g.map((e=>O(e)))),this._objectCache.onCommit(e),this._objectCache.removeChanges(function(e){const t={};return Object.keys(e).forEach((n=>{t[n]=Object.keys(e[n])})),t}(n)),{};function y(e){return Object.assign({},e,(0,o.mapObject)(n[e.guid],(e=>e.value)))}}rollback(e){this._objectCache.removeAllChanges(e);const t=e.filter((e=>this._objectCache.isNew(e)));return this._objectCache.onDelete(t),Promise.resolve({})}validate(e){return Promise.resolve({})}async saveDocument(e,t,n,s){if(s.size/1048576>n.maxFileSize)throw new c.DescribedError("File too large");const a=await this._getByGuid(e),o=(0,i.getFsFileName)((0,r.getRuntimeGuid)(e),a?a.changedDate:void 0);await this._fileBackend.storeFile(s,this._fileBackend.toAbsolutePath(i.DOCUMENT_DIR+"/"+o)),this._objectCache.makeChange(e,"HasContents",!0),await this.commit([e],null)}getDocumentUrl(e,t,n,s){return this._getDocumentUrl((0,i.getFsFileName)((0,r.getRuntimeGuid)(e),t),t,n)}getImageUrl(e){return Promise.resolve(e)}async cleanup(){await(0,m.offlineData)().cleanDatabase(),await this._fileBackend.removeDir(this._fileBackend.toAbsolutePath(i.DOCUMENT_DIR)),await this._fileBackend.removeDir(this._fileBackend.toAbsolutePath(i.THUMBNAIL_DIR)),(0,s.clearDirtyGuids)()}async remove(e){const{mxobjs:t}=await this.getByGuid(e);await(0,m.offlineData)().delete(t)}_getByGuid(e){return(0,f.memoizeConcurrent)(e,(()=>this._store.getByGuid((0,r.getRuntimeGuid)(e)).then((e=>null===e?null:j(r.syncedObjsRuntimeToOfflineMap.mapMxObjectJSON(O(e)))))))}}function b(e){return j(e.jsonData)}function y(e,t,n){var s=i.DEFAULT_FILES_DIRECTORY+"/"+(n?i.THUMBNAIL_DIR:i.DOCUMENT_DIR);return`filesystem:${window.mx.appUrl}temporary/${s}/${e}?${Date.now()}`}function O(e){const t={};for(const n in e)e.hasOwnProperty(n)&&"guid"!==n&&"$"!==n[0]&&(t[n]={value:e[n]},e.$readonlyAttrs.includes(n)&&(t[n].readonly=!0));return{guid:e.guid,objectType:e.$objectType,attributes:t}}function j(e){const t={guid:e.guid,$objectType:e.objectType,$readonlyAttrs:[]};for(const n in e.attributes)t[n]=e.attributes[n].value,e.attributes[n].readonly&&t.$readonlyAttrs.push(n);return t}t.OfflineDataBackend=g},8437:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.buildOfflineDataBackend=async function(e,t,n,o,c,u){const l=new s.OfflineData(n,e,o,t,c);await l.initialize(i.Migrations);const d=new r.SqlStore(t);return{dataBackend:new a.OfflineDataBackend(e,d,o,u),offlineData:l}};var i=n(6040),s=n(4273),a=n(2314),r=n(1264)},172:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SqlSelectBuilder=void 0,t.equalsBuilder=function(e){return{build:t=>(e.indexOf(".")>-1?e:`${t}.[${e}]`)+" = ?"}};var i=n(4337);t.SqlSelectBuilder=class{constructor(){this._from=null,this._prefixedFrom=null,this._join=null,this._constraints=[]}from(e){return this._from=e,this._prefixedFrom=(0,i.toUserScopedName)(e),this}join(e,t,n){return this._join={tableNameAlias:e,tableName:(0,i.toUserScopedName)(e),joinOnColumn:t,selectedColumns:n},this}where(e){return this._constraints.push(e),this}selectDistinct(e){return Array.isArray(e)&&(e=e.join(", ")),`SELECT DISTINCT ${e} ${this._buildSql()}`}select(){let e=`SELECT ${this._from}.*`;return this._join&&this._join.selectedColumns.forEach((t=>{e+=`, ${this._join.tableNameAlias}.[${t}] as "${this._join.tableNameAlias}.${t}"`})),e+this._buildSql()}_buildSql(){let e=` FROM ${this._prefixedFrom} AS ${this._from}`;return this._join&&(e+=` JOIN ${this._join.tableName} AS ${this._join.tableNameAlias} USING (${this._join.joinOnColumn})`),this._constraints.length>0&&(e+=" WHERE "+this._constraints.map((e=>e.build(this._from))).join(" AND ")),e}}},1264:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SqlStore=void 0;var i=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var n=r(t);if(n&&n.has(e))return n.get(e);var i={},s=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var a in e)if("default"!==a&&Object.prototype.hasOwnProperty.call(e,a)){var o=s?Object.getOwnPropertyDescriptor(e,a):null;o&&(o.get||o.set)?Object.defineProperty(i,a,o):i[a]=e[a]}return i.default=e,n&&n.set(e,i),i}(n(9516)),s=n(637),a=n(5234);function r(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(r=function(e){return e?n:t})(e)}t.SqlStore=class{constructor(e){this._database=e}getByGuid(e){const t=i.createFetchByGuidTransaction(e);return(0,s.promiseFromTask)((0,a.runReadTransaction)(this._database,t))}getByAttribute(e,t,n){const r=i.createFetchByAttributeTransaction(e,t,n);return(0,s.promiseFromTask)((0,a.runReadTransaction)(this._database,r))}}},5234:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.runReadTransaction=void 0;var i=n(1650);const s=("readTransaction",function(e,t){return new i.Task((function(n,i){var s,a=2;e.readTransaction((function(e){t.run(e).fork(n,(function(e){s=e,0==--a&&i(s)}))}),n,(function(){0==--a&&i(s)}))}))});t.runReadTransaction=s},9516:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.createFetchByAttributeTransaction=function(e,t,n){const a=(0,o.getEntityMeta)(e);return f((new s.SqlSelectBuilder).from(u(e)).where((0,s.equalsBuilder)(u(t))).join(i.METADATA_TABLE,"guid",["syncId","readonlyAttrs"]).select(),[n]).map((function(e){const t=[];for(let n=0;n<e.rows.length;++n){const s=e.rows.item(n),r=s[`${i.METADATA_TABLE}.${i.SYNC_ID_COLUMN}`],o=h(s,"readonlyAttrs");t.push(d(a,r,o,s))}return t}))},t.createFetchByGuidTransaction=function(e){return f((new s.SqlSelectBuilder).from(i.METADATA_TABLE).where((0,s.equalsBuilder)("guid")).select(),[e]).chain((function(t){if(0===t.rows.length)return r.TaskReader.of(null);if(1!==t.rows.length)return r.TaskReader.rejected(new Error("db consistency error"));const n=t.rows.item(0),i=n.tableName,a=n.syncId,c=n.readonlyAttrs;return f((new s.SqlSelectBuilder).from(u(i)).where((0,s.equalsBuilder)("guid")).select(),[e]).chain((function(e){return 0===e.rows.length?r.TaskReader.rejected(new Error("entity not found")):1!==e.rows.length?r.TaskReader.rejected(new Error("db consistency error")):r.TaskReader.of(d((0,o.getEntityMeta)(i),a,c,e.rows.item(0)))}))}))};var i=n(8609),s=n(172),a=n(1650),r=n(790),o=n(4037),c=n(6304);function u(e){return e.replace(".","$")}function l(e){return e.replace("$",".")}function d(e,t,n,i){const s={guid:i.guid,$objectType:e.name,$syncId:t,$readonlyAttrs:JSON.parse(n)};for(const t in i){var a;if("guid"===(r=t)||r.indexOf(".")>-1)continue;const n=l(t),o=null===(a=e.attributes[n])||void 0===a?void 0:a.type;s[n]=(0,c.sqlToRuntime)(i[t],o)}var r;return s}function h(e,t){return e[`${i.METADATA_TABLE}.${t}`]}function f(e,t){return t=t||[],new r.TaskReader((function(n){return new a.Task((function(i,s){n.executeSql(e,t,((e,t)=>s(t)),((e,t)=>i(t)))}))}))}},637:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.promiseFromTask=function(e){return new Promise((function(t,n){e.fork(n,t)}))}},7779:(e,t,n)=>{n.r(t),n.d(t,{AsyncTaskThrottler:()=>i});class i{constructor(e,t=4){this.taskHandlingFn=e,this.concurrentTasks=t,this.taskQueue=[],this.tasksInProgress=0}async addToQueue(...e){return new Promise(((t,n)=>{this.taskQueue.push({args:e,resolve:t,reject:n}),this.processQueue()}))}processQueue(){if(this.tasksInProgress>=this.concurrentTasks)return;const e=this.taskQueue.splice(0,this.concurrentTasks-this.tasksInProgress);this.tasksInProgress+=e.length,e.forEach((e=>{const{args:t,resolve:n,reject:i}=e;this.taskHandlingFn(...t).then((e=>{this.tasksInProgress--,n(e),this.processQueue()})).catch((e=>{this.tasksInProgress=0,this.taskQueue=[],i(e)}))}))}}},4273:(e,t,n)=>{n.r(t),n.d(t,{OfflineData:()=>he,createGuidsForOfflineObjects:()=>fe,updateOfflineObjectsGuids:()=>me});var i=n(3482),s=n(3282),a=n(234),r=n(1881),o=n(3698),c=n(2351),u=n(7680),l=n(7606),d=n(4037),h=n(1016),f=n(6559),m=n(7754),p=n(6297),g=n(2228),b=n(2664),y=n(6355),O=n(6596),j=n(8609),w=n(6304),v=n(4802),T=n(4337);function E(e,t){if(0===t.length)throw new a.AssertionError("No guids specified");return(0,v.I)(t).flatMap((t=>{const n=new Array(t.length).fill("?").join(", ");return[[`DELETE FROM "${(0,T.toUserScopedName)((0,w.toSafeKey)(e))}" WHERE ${j.GUID_COLUMN} IN (${n})`,t],[`DELETE FROM "${(0,T.toUserScopedName)(j.METADATA_TABLE)}" WHERE ${j.TABLE_NAME_COLUMN} = "${e}" AND ${j.GUID_COLUMN} IN (${n})`,t]]}))}function _(e){return[`DELETE FROM "${(0,T.toUserScopedName)(e)}"`,[]]}var A=n(2235),M=n(8718),D=n(1070),S=n(2381);async function N(e,t,n,i,a,o){if(0===e.length)return;const u=(0,s.uniqueBy)(e,(e=>e.getGuid())),l=D.syncedObjsRuntimeToOfflineMap.reverse(),[f,g,w]=u.reduce((([e,n,i],s)=>{const a=!t.isNew(s.getGuid());return a&&(0,O.AF)(l.map(s.getGuid()))&&e.push(s),s.isPersistable()&&(n.push(s),a&&i.push(s)),[e,n,i]}),[[],[],[]]),v=w.reduce(((e,t)=>{const n=t.getEntity();return e.has(n)||e.set(n,[]),e.get(n).push(t.getGuid()),e}),new Map),_=l.map(f.flatMap((e=>e.isPersistable()&&!a.has(e.getEntity())?e.getGuid():[]))),N=(0,h.getSession)();await(0,m.Fe)(Array.from(v).flatMap((([e,t])=>E(e,l.map(t))))).chain((e=>(0,O.as)(N.getSessionObjectId(),_.length))).chain((e=>{const t=_.map(((t,n)=>function(e,t){return[`INSERT OR REPLACE INTO "${(0,T.toUserScopedName)(j.TOMBSTONE_TABLE)}" ("${j.GUID_COLUMN}", "${j.SYNC_ID_COLUMN}") VALUES (?, ?)`,[e,null!=t?t:null]]}(t,e[n])));return(0,m.Fe)(t)})).chain((e=>{const t=(0,y.createMemoizedCache)((e=>(0,A.$P)(e,i,!1)));return(0,m.Fe)(g.flatMap((e=>{var n;return(0,M._)(null!==(n=t(e.getEntity()))&&void 0!==n?n:{},l.map(e.getGuid()),null)})))})).write(o);const $=(e,t)=>(0,S.createFilePath)(e,l,n.toAbsolutePath((t?S.THUMBNAIL_DIR:S.DOCUMENT_DIR)+"/")),C=w.filter((({jsonData:e})=>(0,d.isFileDocumentWithContents)(e))).flatMap((({jsonData:e})=>(0,d.isImage)(e.objectType)?[$(e,!1),$(e,!0)]:$(e,!1)));(0,S.executeFileInstructions)({deletes:C},n).catch(r.handleError);const L=u.map((e=>e.getGuid())),R=t.getAllObjects().filter((e=>!l.has(e.getGuid())&&!L.includes(e.getGuid()))),F=(0,s.unique)(R.flatMap((e=>e.isPersistable()?[]:e.getEntity()))),U=(0,y.createMemoizedCache)((e=>(0,A.$P)(e,[...i,...F],!0))),B=(0,s.unique)(u.map((e=>e.getEntity()))),I=B.flatMap((e=>{var t;return Object.values(null!==(t=U(e))&&void 0!==t?t:{})})).flat(),k=R.flatMap((e=>{const t=I.flatMap((t=>{if(e.has(t)){const n=e.getReferences(t).filter((e=>L.includes(e)));return!e.isReadonlyAttr(t)&&n.length>0?[[t,n]]:[]}return[]}));return t.length>0?[[e,new Map(t)]]:[]})),P=k.map((([e,t])=>{const n=(0,b.clone)(e.jsonData);return t.forEach(((t,i)=>{const s=n.attributes[i].value;e.isObjectReferenceSet(i)&&Array.isArray(s)?n.attributes[i].value=s.filter((e=>!t.includes(e))):n.attributes[i].value=null})),n})),[G,x]=R.reduce((([e,n],i)=>{const a=i.getGuid();return Object.entries(t.getChanges(a)).filter((([e,t])=>I.includes(e))).forEach((([t,r])=>{const o=r.value;var c,u,l,d;i.isObjectReferenceSet(t)||!L.includes(o)?Array.isArray(o)&&o.some((e=>L.includes(e)))&&(1===o.length||o.every((e=>L.includes(e)))?W(e,a,t):r.hash||(c=n,u=a,l=t,d=o.filter((e=>!L.includes(e))),c.has(u)||c.set(u,{}),(0,s.ensure)(c.get(u))[l]={value:d})):W(e,a,t)})),[e,n]}),[new Map,new Map]);t.onDelete(L),t.setMxObjects(P),t.removeChanges(Object.fromEntries(G)),t.addChanges(Object.fromEntries(x)),(0,p.unmarkAsDirty)(L.filter(p.isDirtyGuid)),f.forEach((e=>{const t=e.getGuid();l.has(t)&&D.syncedObjsRuntimeToOfflineMap.remove(l.map(t))}));const J=k.flatMap((([e,t])=>Array.from(t.keys()).map((t=>({guid:e.getGuid(),attr:t})))));function W(e,t,n){e.has(t)||e.set(t,[]),(0,s.ensure)(e.get(t)).push(n)}await(0,c.publish)(...B.map((e=>({entity:e}))),...J,...L.map((e=>({guid:e}))))}var $=n(7566),C=n(6218),L=n(5835),R=n(4644),F=n(6671);function U(e,t){return[B(e),I(e,t)]}function B(e){const t=[`"${j.GUID_COLUMN}"`],n=[e.guid],i=(0,d.getEntityMeta)(e.objectType);return Object.entries(e.attributes).forEach((([e,s])=>{var a;const r=null===(a=null==i?void 0:i.attributes[e])||void 0===a?void 0:a.type;void 0!==r&&(t.push(`"${(0,w.toSafeKey)(e)}"`),n.push((0,w.runtimeToSql)(s.value,r)))})),[`INSERT OR REPLACE INTO "${(0,T.toUserScopedName)((0,w.toSafeKey)(e.objectType))}" (${t.join(", ")}) VALUES (${(0,s.repeat)(n.length,(()=>"?")).join(", ")})`,n]}function I(e,t){const n=`INSERT OR REPLACE INTO "${(0,T.toUserScopedName)(j.METADATA_TABLE)}" ("${j.GUID_COLUMN}", "${j.TABLE_NAME_COLUMN}", "${j.SYNC_ID_COLUMN}", "${j.READONLY_COLUMN}") VALUES (?, ?, ?, ?)`,i=Object.entries(e.attributes).filter((([,e])=>e.readonly)).map((([e])=>e));return[n,[e.guid,e.objectType,null!=t?t:null,JSON.stringify(i)]]}function k(e){return"push_to_client"===e.type}function P(e){return e.filter(k).flatMap((e=>e.args.guids))}async function G(e,t,n,i,s,r,o=new g.t,c="nothing"){const u=function(e){const t=new Set(e),n=[];return e=>!(void 0===e||!t.has(e)&&(n.includes(e)||(n.push(e),l.LogManager.get().getLogger(l.LogNode.Synchronization).warn(`Object of type ${e} cannot be pushed to client, skipping it.`)),1))}(s),d=(0,O.LV)(n);let h=new m.YW;e.length>0&&(h=h.chain((()=>(0,m.Fe)((0,A.P2)(e)))).chain((e=>e.flat())).chain((e=>Object.assign({},...e.map((e=>({[e[j.GUID_COLUMN]]:e[j.TABLE_NAME_COLUMN]})))))).chain((t=>{const n={},i={};e.forEach((e=>{var s,a,r;const o=d[e],c=null!==(s=null==o?void 0:o.objectType)&&void 0!==s?s:t[e];c&&u(c)&&(i[c]=null!==(a=i[c])&&void 0!==a?a:[]).push(e),c&&u(null==o?void 0:o.objectType)&&(n[c]=null!==(r=n[c])&&void 0!==r?r:[]).push(o)}));const s=Object.keys(i).flatMap((e=>E(e,i[e]))),r=Object.keys(n).flatMap((e=>n[e].flatMap((e=>U(e))))),o=s.concat(r),l=Object.values(n).flatMap((e=>e.map((e=>e.guid))));return"clean"===c&&l.length>0&&o.push(...function(e){if(0===e.length)throw new a.AssertionError("No guids specified");return(0,v.I)(e).flatMap((e=>{const t=new Array(e.length).fill("?").join(", ");return[[`DELETE FROM "${(0,T.toUserScopedName)(j.TOMBSTONE_TABLE)}" WHERE "${j.GUID_COLUMN}" IN (${t})`,e]]}))}(l)),(0,m.Fe)(o)}))),"reset"===c&&(h=h.chain((()=>(0,m.Fe)([_(j.TOMBSTONE_TABLE)])))),await h.write(t),e.filter((e=>!Object.prototype.hasOwnProperty.call(d,e))).forEach((e=>{let t=e;o.has(e)?t=o.map(e):r.has(e)&&(t=r.map(e));const n=i.getObject(t);null!==n&&n.markAsUnavailable()})),e.filter((e=>o.has(e))).forEach((e=>r.add(e,o.map(e)))),(0,p.unmarkAsDirty)(e.map((e=>r.map(e))))}var x=n(9568);function J(e){return"entity"in e}function W(e){return"guid"in e&&!("attr"in e)}function q(e,t){var n;return!(null===(n=(0,d.getEntityMeta)(e))||void 0===n?void 0:n.isPersistable)||t.includes(e)}function Y(e,t,n){const i=(0,O.LV)(t);return e.filter((e=>{var t,s,a;const r=null!==(t=i[e])&&void 0!==t?t:null===(s=n.getObject(e))||void 0===s?void 0:s.jsonData;return r&&!1===(null===(a=(0,d.getEntityMeta)(r.objectType))||void 0===a?void 0:a.isPersistable)}))}function z(e,t){return Object.assign({},...Object.keys(e).filter((e=>t.has(e))).map((t=>({[t]:e[t]}))))}function V(e,t,n){return e.flatMap((e=>{switch(e.type){case"refresh_class":const i=e.args.classnames.filter((e=>{var t;return!1===(null===(t=(0,d.getEntityMeta)(e))||void 0===t?void 0:t.isPersistable)}));return i.length>0?[{...e,args:{classnames:i}}]:[];case"refresh_object_list":const s=Y(e.args.ObjectIds,t,n);return s.length>0?[{...e,args:{ObjectIds:s}}]:[];case"push_to_client":return e;default:return[]}}))}function H(e,t,n,i){return Object.assign({},...Object.entries(e).map((([e,a])=>{var r;const o=(null!==(r=t.find((t=>t.guid===e)))&&void 0!==r?r:(0,s.ensure)(n.getObject(i.map(e))).jsonData).objectType,c=(0,d.getEntityMeta)(o);return c?{[i.map(e)]:i.mapChange(a,c)}:{[e]:a}})))}function K(e,t){return Object.assign({},...Object.keys(e).map((n=>({[t.map(n)]:e[n]}))))}function Q(e,t){return e.map((e=>"push_to_client"===e.type?{...e,args:{guids:t.map(e.args.guids)}}:e))}var X=n(6040),Z=n(9505),ee=n(3354),te=n(6201),ne=n(7946);class ie{constructor(e){this.attrs=[],this.tableNameAlias=(0,w.toSafeKey)(e),this.tableName=(0,T.toUserScopedName)(this.tableNameAlias),this.fromClause=`FROM ${this.tableName} AS ${this.tableNameAlias}`}filtered(e){const{type:t,expr:n,params:i}=(0,v.O)(e,this.tableNameAlias);return"null"!==t&&(this.whereClause=`WHERE ${n}`,this.bindParameters=i),this}sorted(e){const t=e.map((([e,t])=>`${this.tableNameAlias}.[${(0,w.toSafeKey)(e)}] ${t}`)).join(", ");return this.orderClause=t?`ORDER BY ${t}`:"",this}paged(e,t){return this.limitClause=`LIMIT ${void 0!==t&&t>0?t:-1} OFFSET ${null!=e?e:0}`,this}attributes(e){return this.attrs=e,this}buildSelectWithMeta(){var e;const t=(0,T.toUserScopedName)(j.METADATA_TABLE);return[["SELECT",this.attrs.map((e=>`${this.tableNameAlias}.[${(0,w.toSafeKey)(e)}] AS "${(0,w.toSafeKey)(e)}"`)).concat(j.METADATA_COLUMNS.map((e=>`${j.METADATA_TABLE}.[${e}] AS "${j.METADATA_TABLE}.${e}"`))).join(", "),this.fromClause,`JOIN ${t} AS ${j.METADATA_TABLE} USING (${j.GUID_COLUMN})`,this.whereClause,this.orderClause,this.limitClause].filter((e=>e)).join(" "),null!==(e=this.bindParameters)&&void 0!==e?e:[]]}buildCount(){var e;return[['SELECT COUNT("guid") AS count',this.fromClause,this.whereClause].filter((e=>e)).join(" "),null!==(e=this.bindParameters)&&void 0!==e?e:[]]}}function se(e,t){const n=void 0!==t?t.name:e[`${j.METADATA_TABLE}.${j.TABLE_NAME_COLUMN}`],i={guid:e[`${j.METADATA_TABLE}.${j.GUID_COLUMN}`],attributes:{},objectType:n},s=JSON.parse(e[`${j.METADATA_TABLE}.${j.READONLY_COLUMN}`])||[];return Object.keys(e).filter((e=>!e.startsWith(j.METADATA_TABLE)&&e!==j.GUID_COLUMN)).forEach((n=>{var a,r;const o=(0,w.fromSafeKey)(n),c=null!==(r=null===(a=null==t?void 0:t.attributes[o])||void 0===a?void 0:a.type)&&void 0!==r?r:"String";i.attributes[o]={value:(0,w.sqlToRuntime)(e[n],c),...s.includes(o)?{readonly:!0}:{}}})),i}var ae=n(6199),re=n(1488);async function oe(e,t,n,i,o,c,u,l=new Set){try{return await async function(e,t,n,{schema:i,preserveData:o,fetch:c,never:u},l,p,g,b){const y=p?{}:Object.fromEntries(Object.entries(l).filter((([e])=>o.includes(e))).map((([e,t])=>[e,t]))),v=new f.Stopwatch;b.trace("Fetching objects.");const _=await async function(e,t,n){return(await Promise.all([...e.map((({store:e,xpath:t})=>async function(e,t){var a,r;n.trace(`Fetching objects by XPath: ${t}`);const o=new f.Stopwatch,c=await(0,R.retrieveByXPath)(t);return n.trace(`Fetched ${null!==(r=null===(a=c.objects)||void 0===a?void 0:a.length)&&void 0!==r?r:0} objects by XPath ${t} in ${o.measure()} milliseconds.`),i(e,(0,s.ensure)(c.objects),(0,s.ensure)(c.resultGuids))}(e,t))),async function(){var e,a,r;const o=Object.values(t).flat();if(0===o.length)return[];n.trace(`Fetching ${o.length} preserved objects.`);const c=new f.Stopwatch,u=await(0,R.retrieveByIds)(o,{});return n.trace(`Fetched  ${o.length===(null===(e=u.objects)||void 0===e?void 0:e.length)?o.length:`${null!==(r=null===(a=u.objects)||void 0===a?void 0:a.length)&&void 0!==r?r:0} of ${o.length}`} preserved objects in ${c.measure()} milliseconds.`),Object.entries(t).flatMap((([e,t])=>i(e,(0,s.ensure)(u.objects),t.filter((e=>u.resultGuids.includes(e))))))}()])).flat();function i(e,t,n){const i=t.reduce(((e,t)=>(e[t.guid]=t,e)),{});return n.map((t=>{const n=i[t];return n.objectType=e,n}))}}(c,y,b);b.trace(`Fetched ${_.length} objects and completed in ${v.measure()}ms.`),b.trace("Calculating file operations.");const[M,N]=await async function(e,t,n,i,s){const r=s?[]:await async function(e,t){if(t.some((e=>!(0,d.isFileDocument)(e))))throw new a.AssertionError("Non-file document entity passed.");const n=t.map((e=>new ie(e).attributes([d.SystemAttribute.ChangedDate]).buildSelectWithMeta())),i=await(0,m.Fe)(n).read(e),s=[];return i.forEach((e=>e.forEach((e=>{var t;const n=(0,O.GA)(e),i=null!==(t=e[d.SystemAttribute.ChangedDate])&&void 0!==t?t:void 0;s.push([n,i])})))),s}(t,i.filter((e=>(0,d.isFileDocument)(e)))),o=n.toAbsolutePath(S.DOCUMENT_DIR)+"/",c=r.map((([e,t])=>o+(0,S.getFsFileName)(e,null!=t?t:null))),u=n.toAbsolutePath(S.THUMBNAIL_DIR)+"/",l=r.map((([e,t])=>u+(0,S.getFsFileName)(e,null!=t?t:null))),[h,f]=await ce(n,e,c,!1),[p,g]=await ce(n,e,l,!0);return[h.concat(p),f.concat(g)]}(_,e,t,o,p);b.trace(`${M.length} files to be downloaded, ${N.length} files to be removed`),b.trace("Downloading files."),v.reset();const $=await(0,S.downloadFiles)(M,t,b),C=$.size>0?_.filter((e=>!$.has(e.guid))):_;b.trace(`Downloaded ${M.length-$.size} files in ${v.measure()} milliseconds.`),b.trace("Compute cached objects to update or delete."),v.reset();const[L,F]=function(e,t,n,i,a){const r=D.syncedObjsRuntimeToOfflineMap.reverse(),o=e.getAllObjects().filter((t=>{var s;if(!t.isPersistable()||e.isNew(t.getGuid()))return!1;if(a||!n.includes(t.getEntity()))return!0;const r=null!==(s=i[t.getEntity()])&&void 0!==s?s:[];return D.syncedObjsRuntimeToOfflineMap.map(r).includes(t.getGuid())})).map((e=>{const n=r.map(e.getGuid()),i=t.find((e=>e.guid===n));return[i?D.syncedObjsRuntimeToOfflineMap.mapMxObjectJSON(i):void 0,e]})),[c,u]=(0,s.partition)((([e])=>void 0!==e),o);return[c.map((([e])=>e)),u.map((([e,t])=>t.getGuid()))]}(n,C,o,l,p);b.trace(`Compute cached objects to update or delete completed in ${v.measure()} milliseconds. ${L.length} objects will be updated, ${F.length} will be deleted.`),b.trace("Computing subscription updates."),v.measure();const B=function(e,t,n,i,s,a,r){return[...e.filter((e=>!(!r&&t.has(e))||void 0!==i[e]&&!i[e].every((e=>void 0!==n.find((t=>t.guid===e)))))).map((e=>({entity:e}))),...s.map((e=>({guid:e}))),...a.map((e=>({guid:e})))]}(i,new Set([...o,...u]),C,y,L.map((e=>e.guid)),F,p);return b.trace(`Computing subscription updates completed in ${v.measure()} milliseconds.`),b.trace("Rebuilding the database."),v.reset(),await async function(e,t,n,i,s,a=new Set){const r=t.filter((e=>!s.includes(e))),o=0===s.length,c=new Set([...r,...a]);let u=Array.from(c).map((e=>(0,te.W)((0,w.toSafeKey)(e))));const l=(0,h.getSession)();o?(u.push((0,te.W)(j.METADATA_TABLE)),u.push((0,ee.SW)((0,T.toUserScopedName)(j.DB_OFFLINE_METADATA_KEY),JSON.stringify(l.getOfflineMetadata())))):u=u.concat((0,A.CW)(r),Object.entries(i).map((([e,t])=>E(e,t))).flat()),u=u.concat((0,Z.UV)(r)),u=u.concat(n.map((e=>U(e))).flat()),await(0,m.Fe)(u).write(e)}(e,i,C,Object.fromEntries(Object.entries(y).map((([e,t])=>[e,D.syncedObjsRuntimeToOfflineMap.map(t)]))),p?[]:[...o,...u],g),b.trace(`Rebuilding the database completed in ${v.measure()} milliseconds.`),b.trace(`Updating cache. ${L.length} to be updated, ${F.length} to be deleted.`),v.reset(),n.setMxObjects(L),n.onDelete(F),b.trace(`Updating cache completed in ${v.measure()} milliseconds.`),b.trace(`Removing ${N.length} files.`),v.reset(),Promise.all(N.map((e=>t.removeFile(e)))).catch(r.handleError),b.trace(`Removing ${N.length} files completed in ${v.measure()} milliseconds.`),B}(e,t,n,i,o,c,l,u)}catch(e){throw u.warn(e),new re.t}}async function ce(e,t,n,i){const s=e.toAbsolutePath(i?S.THUMBNAIL_DIR:S.DOCUMENT_DIR)+"/",a=t.filter((e=>(0,d.isFileDocumentWithContents)(e,i))).map((e=>{var t;const n=null===(t=e.attributes.changedDate)||void 0===t?void 0:t.value;return{sourceUrl:(0,ae.getRemoteDynamicResourceUrl)(e.guid,null!=n?n:null,i),downloadPath:s+(0,S.getFsFileName)(e.guid,null!=n?n:null),guid:e.guid}})),r=(await e.listDir(s)).map((e=>s+e));return[a.filter((e=>!r.includes(e.downloadPath))).map((({sourceUrl:e,downloadPath:t,guid:n})=>[e,t,n])),r.filter((e=>!a.find((t=>t.downloadPath===e))&&!n.includes(e)))]}var ue=n(8569);async function le({dirtyMxObjects:e,syncedObjsOfflineToRuntimeMap:t,returnObjects:n,deletes:i={},extraGuidsToRetrieve:s=[],incompatibleObjectsJson:a=[],logger:r,database:o,fileBackend:c,offlineEntities:u}){r.trace(`Syncing of ${e.length} objects.`);const l=e.map((e=>t.mapMxObjectJSON(e.jsonData))),h=e.filter((e=>!(0,O.AF)(t.map(e.getGuid()))));r.trace(`Creating guids for ${h.length} offline objects.`);const m=new f.Stopwatch,p=await fe(h,R.createGuids);r.trace(`Created guids for ${h.length} offline objects in ${m.measure()} milliseconds.`),m.reset(),await me(u,h,p,c,o),r.trace(`Updated offline guids with runtime guids in ${m.measure()} milliseconds.`);const g=l.map((e=>p.mapMxObjectJSON(e))),b=await de(g.map((e=>e.guid)),o);r.trace("Uploading file documents."),m.reset();const y=await Promise.all(g.filter((e=>(0,d.isFileDocumentWithContents)(e))).concat(a.filter((e=>(0,O.pw)(e)))).map((async e=>{r.trace(`Uploading file content of ${e.objectType} with guid ${e.guid}.`);const t=new f.Stopwatch,n=await(0,S.tempUploadFile)(c,e);return r.trace(`Uploaded file content of ${e.objectType} with guid ${e.guid} in ${t.measure()} milliseconds.`),n})));r.trace(`Uploaded file documents in ${m.measure()} milliseconds.`);const j=g.map((e=>({guid:e.guid,syncId:b[e.guid],changes:(0,O.fc)(e),...(0,O.AF)(e.guid)?{}:{objectType:e.objectType}}))),w=await de(a.map((e=>e.guid)),o),v=a.map((e=>({guid:e.guid,objectType:e.objectType,syncId:w[e.guid],changes:(0,O.rJ)(e)}))),T=y.reduce(((e,t)=>t.tempGuid?{...e,[t.tempGuid]:t.fileObjGuid}:e),{});r.trace("Syncing objects with runtime."),m.reset();const E=n?await(0,R.synchronizeObjects)(j,T,!0,i,t.map(s)):await(0,R.synchronizeObjects)(j,T,!1,i,[],v);return r.trace(`Synced objects with runtime in ${m.measure()} milliseconds.`),{response:E,createdGuidsMapping:p}}async function de(e,t){return(0,m.Fe)((0,A.dT)(e)).chain((e=>e.flat().reduce(((e,t)=>(e[t[j.GUID_COLUMN]]=t[j.SYNC_ID_COLUMN],e)),{}))).read(t)}class he{constructor(e,t,n,i,s=l.LogManager.get()){this.syncConfig=e,this.objectCache=t,this.fileBackend=n,this.database=i,this.startupLogger=s.getLogger(l.LogNode.Startup),this.syncLogger=s.getLogger(l.LogNode.Synchronization),this.selectiveSyncLogger=s.getLogger(l.LogNode.SelectiveSync)}async initialize(e){const t=(0,A.FA)(j.METADATA_TABLE);await(0,m.Rj)(t).chain((t=>{const n=0===(0,s.ensure)(t[0]).cnt?(0,X.getLatestVersion)(e):0,i=(0,Z.UV)(this.syncConfig.schema).concat((0,Z.ZI)(n),[(0,Z.cU)()]);return(0,m.Fe)(i)})).write(this.database),await this.applyMigrations(e);const{dirtyObjects:n}=await this.retrieveDirtyObjects();(0,p.markAsDirty)(n.map((e=>e.getGuid())))}async downloadObjects(e,t,n){this.syncLogger.trace("Downloading objects");const i=new f.Stopwatch,s=oe(this.database,this.fileBackend,this.objectCache,this.syncConfig,e,t,this.syncLogger,n);return this.syncLogger.info(`Downloading objects completed in ${i.measure()} milliseconds.`),s}async cleanDatabase(){const e=[...this.syncConfig.schema.map((e=>(0,te.W)((0,w.toSafeKey)(e)))),(0,te.W)(j.METADATA_TABLE),(0,te.W)(j.TOMBSTONE_TABLE)];await(0,m.Fe)(e).write(this.database)}async create(e){const t=(0,s.ensure)((0,d.getEntityMeta)(e)),n=t.isPersistable?(0,O.NW)():(0,u.createMendixGuid)(t);return this.objectCache.onCreate([n]),this.objectCache.setMxObjects([(0,o.createMxObjectJSON)(n,t)]),this.objectCache.getObject(n)}async retrieve(e,t,n){const{jsons:i,count:a}=await this.retrieveJson(e,t,n);return this.objectCache.setMxObjects(i),{mxObjects:i.map((e=>(0,s.ensure)(this.objectCache.getObject(e.guid)))),count:a}}async retrieveUncached(e,t,n){const{jsons:s,count:a}=await this.retrieveJson(e,t,n);return{mxObjects:s.map(i.MxObject.fromJson),count:a}}async retrieveDirtyObjects(e=!1,t=new Set){const n=new Set(this.syncConfig.never);return(0,m.Rj)((0,A.Fm)(n)).chain((e=>{const t=e.reduce(((e,t)=>{var n;const i=t[j.TABLE_NAME_COLUMN];return e[i]=(null!==(n=e[i])&&void 0!==n?n:[]).concat(t[j.GUID_COLUMN]),e}),{}),n=Object.entries(t).flatMap((([e,t])=>(0,ne.k)(e,t)));return(0,m.Fe)(n)})).chain((n=>{const a=(e,t)=>{const n=e.has(t)?e.get(t)+1:1;e.set(t,n)},{dirtyObjects:r,incompatibleObjectsJson:o,incompatibleObjectsCount:c}=n.flat().reduce(((n,r)=>{const o=r[`${j.METADATA_TABLE}.${j.TABLE_NAME_COLUMN}`];if(t.has(o))return n.incompatibleObjectsJson.push(se(r)),a(n.incompatibleObjectsCount,o),n;try{const t=se(r,(0,s.ensure)((0,d.getEntityMeta)(o))),a=e?D.syncedObjsRuntimeToOfflineMap.mapMxObjectJSON(t):t;n.dirtyObjects.push(i.MxObject.fromJson(a))}catch(e){n.incompatibleObjectsJson.push(se(r)),a(n.incompatibleObjectsCount,o)}return n}),{dirtyObjects:[],incompatibleObjectsJson:[],incompatibleObjectsCount:new Map});return c.forEach(((e,t)=>{this.syncLogger.warn(`Failed to parse ${e} object${1===e?"":"s"} of type '${t}'and to prevent data loss new 'System.SynchronizationError' corresponding to these failed objects will be created.`)})),{dirtyObjects:r,incompatibleObjectsJson:o}})).read(this.database)}async retrieveDeletes(){return(0,m.Rj)([`SELECT "${j.GUID_COLUMN}", "${j.SYNC_ID_COLUMN}" FROM "${(0,T.toUserScopedName)(j.TOMBSTONE_TABLE)}"`,[]]).chain((e=>Object.fromEntries(e.map((e=>[e[j.GUID_COLUMN],e[j.SYNC_ID_COLUMN]]))))).read(this.database)}async insertOrReplace(e){const t=(0,h.getSession)().getSessionObjectId();await(0,O.as)(t,e.length).chain((t=>{const n=e.map(((e,n)=>U(e,t[n])));return(0,m.Fe)(n.flat())})).write(this.database)}async executeMicroflow(e,t){return async function(e,t,n,i,u,l){var d,h,f,p;const b=(0,$.getGuidsFromRuntimeArguments)(t);if(b.some((e=>!i.has(e))))throw new a.AssertionError("Microflow parameter is not available in the client state");const[y,w]=(0,L.getRequestDataForMicroflow)(i,e,b),v=w.map((e=>e.hash?e:{...e,attributes:Object.fromEntries(Object.entries(e.attributes).filter((([e,t])=>!t.readonly)))})),T=await(0,R.runtimeOperation)(e,t,y,v),E=function({actionResult:e,objects:t=[],changes:n={},resets:i={},deletes:a=[],instructions:r=[]},o){const c=P(r),u=Y((0,s.unique)([...t.map((e=>e.guid)),...Object.keys(n),...Object.keys(i),...a]),t,o),l=new Set(c.concat(u));return{actionResult:e,newpersistable:[],commits:[],committedObjectsOmitted:!1,deletes:(d=a,h=l,d.filter((e=>h.has(e)))),changes:z(n,l),resets:z(i,l),instructions:V(r,t,o),objects:t.filter((e=>l.has(e.guid)))};var d,h}(function({actionResult:e,newpersistable:t=[],objects:n=[],changes:i={},commits:s=[],committedObjectsOmitted:a=!1,resets:r={},deletes:o=[],instructions:c=[]},u,l){return{actionResult:e,committedObjectsOmitted:a,newpersistable:t,commits:s,deletes:u.map(o),instructions:Q(c,u),objects:n.map((e=>u.mapMxObjectJSON(e))),changes:H(i,n,l,u),resets:K(r,u)}}(T,D.syncedObjsRuntimeToOfflineMap,i),i),_=(0,s.unique)(P(null!==(d=T.instructions)&&void 0!==d?d:[])),M=await(0,o.getByGuids)(_),N=null!==(f=null===(h=T.objects)||void 0===h?void 0:h.filter((e=>_.includes(e.guid))))&&void 0!==f?f:[],U=await async function(e,t,n,i){var a,r,o;const c=(0,x.Q)(n,e),u=(0,s.unique)(null!==(r=null===(a=e.instructions)||void 0===a?void 0:a.filter(k).flatMap((e=>e.args.guids)))&&void 0!==r?r:[]),l=(0,O.LV)(null!==(o=e.objects)&&void 0!==o?o:[]),[d,h]=(0,s.partition)((e=>void 0!==l[e]),u),f=Object.assign({},...d.map((e=>({[e]:l[e].objectType}))));if(h.length>0){const e=D.syncedObjsRuntimeToOfflineMap.reverse().map(h);(await(0,m.Fe)((0,A.P2)(e)).chain((e=>e.flat())).read(i)).forEach((e=>{const t=e[j.GUID_COLUMN],n=D.syncedObjsRuntimeToOfflineMap.map(t);f[n]=e[j.TABLE_NAME_COLUMN]}))}const p=(0,s.unique)(c.filter(J).map((e=>e.entity)).concat(Object.values(f))).filter((e=>q(e,t))).map((e=>({entity:e}))),g=Object.entries(f).filter((([e,n])=>q(n,t))).map((([e])=>e)),b=(0,s.unique)(c.filter(W).map((e=>e.guid)).concat(g)).filter((e=>n.has(e))).map((e=>({guid:e})));return[...c.filter((e=>function(e){return"attr"in e}(e)&&!g.includes(e.guid))),...b,...p]}(E,n,i,u),{downloads:B,moves:I,deletes:X}=await(0,S.gatherFileInstructions)(M,N,!1,D.syncedObjsRuntimeToOfflineMap,l);0!==_.length&&(await(0,S.executeFileInstructions)({downloads:B},l),await G(_,u,null!==(p=T.objects)&&void 0!==p?p:[],i,n,D.syncedObjsRuntimeToOfflineMap,new g.t,0!==N.length?"clean":"nothing"),await(0,S.executeFileInstructions)({moves:I},l),(0,S.executeFileInstructions)({deletes:X},l).catch(r.handleError)),await(0,F.handleState)(i,E),U.length>0&&await(0,c.publish)(...U);const Z=T.actionResult;return null==Z?void 0:(0,C.runtimeValueToExpressionVariable)(Z.value,Z.type,(e=>(0,s.ensure)(i.getObject(e))))}(e,t,this.syncConfig.schema,this.objectCache,this.database,this.fileBackend)}async upload(e=new Set){const{dirtyObjects:t,incompatibleObjectsJson:n}=await this.retrieveDirtyObjects(!1,e),i=await this.retrieveDeletes(),a=0!==t.length,r=0!==Object.keys(i).length,o=0!==n.length;if(!(a||r||o))return{};this.syncLogger.trace(`Uploading ${t.length} changes, ${Object.keys(i).length} deletes.`),t.length+N.length>1e3&&this.syncLogger.warn("Uploading excessive amount of data will slow down synchronization.");const c=new f.Stopwatch,u=await le({returnObjects:!1,dirtyMxObjects:t,syncedObjsOfflineToRuntimeMap:D.syncedObjsRuntimeToOfflineMap.reverse(),deletes:i,incompatibleObjectsJson:n,logger:this.syncLogger,database:this.database,fileBackend:this.fileBackend,offlineEntities:this.syncConfig.schema});this.syncLogger.trace(`Synchronizing objects took ${c.measure()} milliseconds.`);const l=_(j.TOMBSTONE_TABLE);if(!a)return await(0,m.Rj)(l).write(this.database),{};const{createdGuidsMapping:d,response:h}=u,g=d.reverse(),b=(0,O.yP)(t),y=Object.entries(h.fileChangedDates).map((([e,t])=>{const n=g.map(e),i=(0,s.ensure)(b[n]);return(0,M.c)(i.metaData,{changedDate:t},j.GUID_COLUMN,e)})),w=(0,A.WU)(t.map((e=>d.map(e.getGuid()))));this.syncLogger.trace("Updating local database with uploaded changes."),c.reset(),await(0,m.Fe)([...y,...w,...r?[l]:[]]).write(this.database),this.syncLogger.trace(`Updating local database took ${c.measure()} milliseconds.`),(0,p.clearDirtyGuids)();const v=Object.entries(h.fileChangedDates).map((([e,n])=>{const i=e,a=g.map(i),r=t.find((e=>e.getGuid()===a)).jsonData,o=this.fileBackend.toAbsolutePath(S.DOCUMENT_DIR+"/");return[o+(0,S.getFsFileName)(i,(0,s.ensure)(r.attributes.changedDate).value),o+(0,S.getFsFileName)(i,n),i]}));this.syncLogger.trace("Executing file instructions for uploaded file documents."),c.reset(),await(0,S.executeFileInstructions)({moves:v},this.fileBackend),this.syncLogger.trace(`Executing file instructions for uploaded file documents took ${c.measure()} milliseconds.`);const T=D.syncedObjsRuntimeToOfflineMap.reverse();return t.reduce(((e,t)=>{var n;const i=t.getEntity();return e[i]=(null!==(n=e[i])&&void 0!==n?n:[]).concat(T.map(t.getGuid())),e}),{})}async selectiveSync(e,t={}){return async function(e,t,n,i,o,u,l){!function(){if((0,s.uniqueBy)(e,(e=>e.getGuid())).length!==e.length)throw new a.AssertionError("Duplicate objects aren't allowed")}(),l.trace("Selective sync started.");const d=new f.Stopwatch,h=await(0,ue.M)((async()=>{const s=e.filter((e=>!i.isNew(e.getGuid()))),a=0!==s.length,c=0!==Object.keys(t).length;if(!a&&!c)return l.trace("Nothing to sync."),[];l.trace(`Selective sync to sync ${e.length} objects and ${Object.keys(t).length} deletes.`);const h=s.map((e=>e.getGuid())),f=D.syncedObjsRuntimeToOfflineMap.reverse(),m=s.filter((e=>(0,p.isDirtyGuid)(e.getGuid()))),g=h.filter((e=>!(0,p.isDirtyGuid)(e)));d.reset();const{createdGuidsMapping:b,response:y}=await le({dirtyMxObjects:m,syncedObjsOfflineToRuntimeMap:f,returnObjects:!0,deletes:t,extraGuidsToRetrieve:g,logger:l,database:o,fileBackend:u,offlineEntities:n});l.trace(`Selective sync synced changes with runtime in ${d.measure()} milliseconds.`);const O=D.syncedObjsRuntimeToOfflineMap.reverse(),j=function(e){const t=new Set(e.map((e=>e.getEntity())));return e.map((e=>({guid:e.getGuid()}))).concat(Array.from(t).map((e=>({entity:e}))))}(s),{downloads:w,moves:v,deletes:T}=await(0,S.gatherFileInstructions)(s,y.objects,!0,D.syncedObjsRuntimeToOfflineMap,u),E=await(0,S.downloadFiles)(w,u,l),_=0===E.size?y.objects:y.objects.filter((e=>!E.has(e.guid)));l.trace("Selective sync to update the local database."),d.reset(),await G(O.map(h),o,_,i,n,D.syncedObjsRuntimeToOfflineMap,b.reverse(),c?"reset":"nothing"),l.trace(`Selective sync updated the local database in ${d.measure()} milliseconds.`);const A=E.size>0?v.filter((([e,t,n])=>!E.has(n))):v;await(0,S.executeFileInstructions)({moves:A},u,l),(0,S.executeFileInstructions)({deletes:T},u,l).catch((e=>(0,r.handleError)(e)));const M=_.flatMap((e=>i.has(D.syncedObjsRuntimeToOfflineMap.map(e.guid))?D.syncedObjsRuntimeToOfflineMap.mapMxObjectJSON(e):[]));return i.setMxObjects(M),j}));h.length>0&&(l.trace("Selective sync to update UI with the latest state of the synchronized objects."),d.reset(),await(0,c.publish)(...h),l.trace(`Selective sync updated the UI with the latest state of the synchronized objects in ${d.measure()} milliseconds.`)),l.trace("Selective sync completed.")}(e,t,this.syncConfig.schema,this.objectCache,this.database,this.fileBackend,this.selectiveSyncLogger)}async delete(e){return N(e,this.objectCache,this.fileBackend,this.syncConfig.schema,new Set(this.syncConfig.never),this.database)}async executeDBModelSyncInstructions(e,t){const n=e.length>1;this.startupLogger.debug(`Found ${e.length} instruction${n?"s":""} to update the local database to the new schema.\n${e.map((e=>`- ${e.getDescription()}`)).join("\n")}`);let i=e.reduce(((e,t)=>e.chain((()=>t.getTransaction()))),new m.YW);i=i.chain((()=>(0,m.Rj)((0,ee.SW)((0,T.toUserScopedName)(j.DB_OFFLINE_METADATA_KEY),JSON.stringify(t))))),await i.write(this.database),await Promise.all(e.map((e=>e.postMigrate())))}deleteFiles(e){if(0===e.length)return;const t=this.fileBackend.toAbsolutePath(S.DOCUMENT_DIR)+"/",n=this.fileBackend.toAbsolutePath(S.THUMBNAIL_DIR)+"/",i=e.map((({guid:e,changedDate:i,isThumb:s})=>`${s?n:t}${(0,S.getFsFileName)(e,i)}`));(0,S.executeFileInstructions)({deletes:i},this.fileBackend).catch((e=>(0,r.handleError)(e)))}async retrieveJson(e,t,n){var i,a;const r=(0,s.ensure)((0,d.getEntityMeta)(e)),o=new ie(e).attributes(Object.values(r.attributes).map((e=>e.name)));void 0!==t&&o.filtered(t),void 0===n.offset&&void 0===n.amount||o.paged(n.offset,n.amount),void 0!==n.sort&&o.sorted(n.sort);const c=o.buildSelectWithMeta(),u=o.buildCount(),[l=[],h=[]]=await(0,m.Fe)([c,u]).read(this.database);return{jsons:l.map((e=>D.syncedObjsRuntimeToOfflineMap.mapMxObjectJSON(se(e,r)))),count:null!==(a=null===(i=h[0])||void 0===i?void 0:i.count)&&void 0!==a?a:0}}async retrieveOfflineMetadata(){const e=(0,ee.sT)((0,T.toUserScopedName)(j.DB_OFFLINE_METADATA_KEY)),t=await(0,m.Rj)(e).read(this.database);return JSON.parse((0,s.ensure)(t[0])[j.DB_VALUE_COLUMN])}async runFullSynchronization(e=!1,t=new Set){const n=await(0,ue.M)((async()=>{const n=await this.upload(t);return this.downloadObjects(n,e,t)}));await(0,c.publish)(...n)}async applyMigrations(e){const t=(0,X.getLatestVersion)(e),n=(0,ee.sT)(j.DB_VERSION_KEY),i=await(0,m.Rj)(n).read(this.database),a=parseInt((0,s.ensure)(i[0])[j.DB_VALUE_COLUMN],10);if(t<=a)return void this.startupLogger.debug("The database schema is up-to-date.");const r=new f.Stopwatch,o=e.findIndex((({version:e})=>e===a)),c=-1===o?e:e.slice(o+1);let u=new m.YW;c.forEach((e=>{u=u.chain((t=>e.apply()))})),u=u.chain((e=>(0,m.Rj)((0,ee.SW)(j.DB_VERSION_KEY,t.toString())).chain((e=>{})))),await u.write(this.database),this.startupLogger.debug(`The app has upgraded the local database version from ${a} to ${t} in ${r.measure()} milliseconds.`)}}async function fe(e,t){const n=e.reduce(((e,t)=>{var n;const i=t.getEntity();return e[i]=(null!==(n=e[i])&&void 0!==n?n:0)+1,e}),{}),i={},s=[];let r=c();for(;Object.entries(r).length>0;){const e=await t(r);if(0===Object.keys(e.success).length&&0===e.failure.length)throw new a.AssertionError("create_guids API did not return a valid response");Object.entries(e.success).forEach((([e,t])=>{var n;i[e]=(null!==(n=i[e])&&void 0!==n?n:[]).concat(t)})),s.push(...e.failure),r=c()}const o=new g.v;return e.filter((e=>!s.includes(e.getEntity()))).forEach((e=>{const t=i[e.getEntity()].shift();o.add(e.getGuid(),t)})),o;function c(){return Object.entries(n).reduce(((e,[t,n])=>{var a,r,o,c;const u=null!==(r=null===(a=i[t])||void 0===a?void 0:a.length)&&void 0!==r?r:0;return!s.includes(t)&&n>u&&(e[t]=n-(null!==(c=null===(o=i[t])||void 0===o?void 0:o.length)&&void 0!==c?c:0)),e}),{})}}async function me(e,t,n,i,s){if(t.some((e=>(0,O.AF)(e.getGuid()))))throw new a.AssertionError("Runtime objects are not expected here");const r=[...(0,A.ku)(t,n),...(0,A.Vf)(t,n,e)],o=i.toAbsolutePath(S.DOCUMENT_DIR),c=t.filter((e=>(0,d.isFileDocumentWithContents)(e.jsonData))).map((e=>{const t=n.map(e.getGuid());return[o+"/"+(0,S.getFsFileName)(e.getGuid(),""),o+"/"+(0,S.getFsFileName)(t,""),t]}));await(0,m.Fe)(r).write(s),await(0,S.executeFileInstructions)({moves:c},i),D.syncedObjsRuntimeToOfflineMap.import(n.reverse())}},6040:(e,t,n)=>{n.r(t),n.d(t,{Migrations:()=>l,getLatestVersion:()=>u});var i=n(3282),s=n(1016),a=n(7754),r=n(6596),o=n(4337),c=n(8609);function u(e){var t,n;return null!==(n=null===(t=e[e.length-1])||void 0===t?void 0:t.version)&&void 0!==n?n:0}const l=[{version:1,apply:()=>{const e=(t=c.METADATA_TABLE,n={name:c.SYNC_ID_COLUMN,type:"text"},[`ALTER TABLE "${(0,o.toUserScopedName)(t)}" ADD ${n.name} ${n.type} ${"text"===n.type?"COLLATE NOCASE":""}`,[]]);var t,n;const u=[`SELECT "${c.GUID_COLUMN}" FROM "${c.METADATA_TABLE}" WHERE "dirty" = ?`,[1]];return(0,a.Rj)(e).chain((()=>(0,a.Rj)(u))).chain((e=>{const t=e.map((e=>e[c.GUID_COLUMN])),n=(0,s.getSession)();return(0,r.as)(n.getSessionObjectId(),t.length).chain((e=>(0,a.Fe)(t.map(((t,n)=>[`UPDATE ${c.METADATA_TABLE} SET ${c.SYNC_ID_COLUMN} = ? WHERE ${c.GUID_COLUMN} = ?`,[(0,i.ensure)(e[n]),t]])))))}))}},{version:2,apply:()=>(0,a.Rj)(["SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%' AND name != 'android_metadata' AND name != ?",[c.DB_META_TABLE]]).chain((e=>{const t=e.map((e=>e.name.toString())).filter((e=>!e.startsWith((0,o.getUserScopedNamePrefix)()))).flatMap((e=>[[`DROP TABLE IF EXISTS ${(0,o.toUserScopedName)(e)}`,[]],[`ALTER TABLE ${e} RENAME TO ${(0,o.toUserScopedName)(e)}`,[]]]));return(0,a.Fe)(t)}))}]}}]);
